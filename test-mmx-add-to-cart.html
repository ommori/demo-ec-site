<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>MMX Add To Cart — Test Page</title>
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-MRSX7MPX');</script>
  <!-- End Google Tag Manager -->
  <script>
  (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-XXXX');
  </script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background:#f6f7fb; color:#222; }
    .wrap { max-width:960px; margin:0 auto; background:#fff; padding:18px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.06); }
    h1 { margin-top:0; font-size:1.4rem; }
    .meta { color:#666; margin-bottom:12px; }
    .product { border: 1px solid #e2e6ea; padding: 12px; margin: 12px 0; display:flex; gap:12px; align-items:flex-start; background:#fafafa; border-radius:4px; }
    .product img { width:100px; height:100px; object-fit:cover; border-radius:4px; border:1px solid #ddd; }
    .product .info { flex:1; }
    .product .info h3 { margin:0 0 6px 0; font-size:1.05rem; }
    .product .info p { margin:4px 0; color:#444; }
    .product .info .small { color:#666; font-size:0.9em; margin-top:6px; }
    .controls { margin-top: 14px; display:flex; gap:10px; align-items:center; }
    label { display:inline-block; width:72px; }
    input[type="text"], input[type="email"] { padding:8px; width:220px; border:1px solid #ccd; border-radius:4px; }
    .qty { width:60px; padding:6px; border:1px solid #ccd; border-radius:4px; }
    button { padding:8px 12px; cursor:pointer; border-radius:4px; border:0; background:#0073e6; color:#fff; }
    button.secondary { background:#6c757d; }
    .links a { color:#0073e6; text-decoration:none; }
    .note { color:#666; font-size:0.9em; margin-top:10px; }
    footer { margin-top:18px; color:#999; font-size:0.85em; }
  </style>
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MRSX7MPX"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
  <div class="wrap">
    <h1>MMX Add To Cart — Test Page</h1>
    <div class="meta">会員ID と Email を入力して、任意の商品を「Add」または「Add All」で dataLayer に mmx_addToCart を push します。</div>

    <div style="margin-bottom:14px;">
      <label for="memberId">会員ID</label>
      <input id="memberId" type="text" placeholder="例: user12345" />
      <label for="email" style="margin-left:12px">Email</label>
      <input id="email" type="email" placeholder="user@example.com" />
      <button id="clearSession" style="margin-left:12px" title="新しい cartId を作る">New Cart</button>
    </div>

    <div id="products">
      <!-- 商品はスクリプトで挿入されます -->
    </div>

    <div class="controls">
      <button id="addAll">Add All Items to Cart</button>
      <button id="showDL" class="secondary">Show Last payload (console)</button>
    </div>

    <div class="note">※「Add」を押すと window.dataLayer に mmx_addToCart イベントを push します。GTM プレビューで mmx_items 等を確認してください。</div>

    <footer>test-mmx-add-to-cart.html — GTM コンテナ ID（GTM-XXXX）を必ず置き換えてください。</footer>
  </div>

  <script>
  // 簡易 UUID v4（cartId 用）
  function uuidv4() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }

  // sessionStorage に cartId を保持
  var CART_KEY = 'mmx_test_cart_id';
  function getSessionCartId() {
    try {
      var v = sessionStorage.getItem(CART_KEY);
      if (!v) {
        v = uuidv4();
        sessionStorage.setItem(CART_KEY, v);
      }
      return v;
    } catch (e) {
      return uuidv4();
    }
  }
  function newCartId() {
    var v = uuidv4();
    try { sessionStorage.setItem(CART_KEY, v); } catch(e){}
    return v;
  }

  // 指定いただいた商品情報（presentersroom の各ページを参照）
  // 変更点: itemAttributes オブジェクトの導入と、productId の削除
  var PRODUCTS = [
    {
      sku: '25991008',
      quantity: 1,
      baseprice: 5500,
      netprice: 5500,
      discount: 0,
      discountType: 'none',
      category: 'カタログギフト',
      description: 'ナチュラル＆オーガニックのセレクトショップ CosmeKitchen と Biople のカードタイプカタログ ギフト（Joy）。',
      itemAttributes: {
        name: 'CosmeKitchen & Biople GIFT CATALOG ＜Joy（ジョイ)＞',
        type: 'catalog',
        subcategory: 'CosmeKitchen & Biople',
        productUrl: 'https://presentersroom.jp/i/991008',
        imageUrl: 'https://via.placeholder.com/300x300?text=CosmeKitchen+Joy'
      }
    },
    {
      sku: '25987006',
      quantity: 1,
      baseprice: 4290,
      netprice: 4290,
      discount: 0,
      discountType: 'none',
      category: 'カタログギフト',
      description: 'ACTUS の冊子カタログギフト（HIKARI）。インテリアや雑貨が充実。',
      itemAttributes: {
        name: 'ACTUS(アクタス) ギフトカタログ ＜HIKARI(光)＞',
        type: 'catalog',
        subcategory: 'ACTUS',
        productUrl: 'https://presentersroom.jp/i/987006',
        imageUrl: 'https://via.placeholder.com/300x300?text=ACTUS+HIKARI'
      }
    },
    {
      sku: '18141006c75097425',
      quantity: 1,
      baseprice: 4400,
      netprice: 4400,
      discount: 0,
      discountType: 'none',
      category: 'グルメ・銘酒カタログ',
      description: '銘酒カタログ（GS01）とごろッとうまみチーズのオイル漬3種のセット。',
      itemAttributes: {
        name: '銘酒カタログギフト ＜GS01＞+Norte Carta / ごろッとうまみチーズオイル漬 3種ギフトセット',
        type: 'catalog+item',
        subcategory: '銘酒',
        productUrl: 'https://presentersroom.jp/i/18141006c75097425',
        imageUrl: 'https://via.placeholder.com/300x300?text=Meishu+GS01'
      }
    }
  ];

  // DOM に商品を描画
  var productsDiv = document.getElementById('products');
  PRODUCTS.forEach(function(p, idx){
    var box = document.createElement('div');
    box.className = 'product';
    // 変更点: 商品名、画像、URL を itemAttributes から取得
    box.innerHTML = ''
      + '<img src="'+p.itemAttributes.imageUrl+'" alt="'+escapeHtml(p.itemAttributes.name)+'" />'
      + '<div class="info">'
      + '<h3>' + p.itemAttributes.name + ' <small style="font-size:0.85em;color:#666;">(' + p.sku + ')</small></h3>'
      + '<p class="small">' + p.description + '</p>'
      + '<p>Price (sample): ¥' + numberWithCommas(p.baseprice) + ' &nbsp; Qty: <input class="qty" data-idx="'+idx+'" type="number" min="1" value="'+p.quantity+'" /></p>'
      + '<p class="small">詳しくは: <a href="'+p.itemAttributes.productUrl+'" target="_blank" rel="noopener noreferrer">' + p.itemAttributes.productUrl + '</a></p>'
      + '</div>'
      + '<div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end;">'
      + '<button data-idx="'+idx+'" class="btnAdd">Add</button>'
      + '</div>';
    productsDiv.appendChild(box);
  });

  // ユーティリティ
  function numberWithCommas(x){ return String(x).replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
  function escapeHtml(str){ return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

  // 最後に push した payload を保存（デバッグ用）
  var lastPayload = null;

  // dataLayer push 用関数（配列オブジェクトを必ず渡す）
  function pushAddToCart(itemsArray) {
    var cartId = getSessionCartId();
    var memberId = document.getElementById('memberId').value || '';
    var email = document.getElementById('email').value || '';

    var payload = {
      cartId: cartId,
      idType: 'external',
      mmx_memberId: memberId,
      email: email,
      profileAttributes: {
        profileMemberId: memberId,
        profileFirstName: 'Test',
        profileLastName: 'User'
      },
      items: itemsArray
    };

    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
      event: 'mmx_addToCart',
      mmx_cartId: cartId,
      mmx_memberId: memberId,
      mmx_email: email,
      mmx_profileAttributes: payload.profileAttributes,
      mmx_items: itemsArray, // 変更点: ここで渡す itemsArray は itemAttributes を含む形式になっている
      mmx_payload: payload
    });

    lastPayload = payload;
    console.log('mmx_addToCart pushed', payload);
    alert('mmx_addToCart pushed — コンソールで payload を確認してください');
  }

  // 個別 Add ボタン処理
  document.querySelectorAll('.btnAdd').forEach(function(btn){
    btn.addEventListener('click', function(ev){
      var idx = parseInt(ev.currentTarget.getAttribute('data-idx'), 10);
      var qtyInput = document.querySelector('.qty[data-idx="'+idx+'"]');
      var qty = parseInt(qtyInput.value, 10) || 1;
      var prod = PRODUCTS[idx];
      // 変更点: itemAttributes オブジェクトを構築
      var item = {
        sku: prod.sku,
        quantity: qty,
        baseprice: prod.baseprice,
        netprice: prod.netprice,
        discount: prod.discount,
        discountType: prod.discountType,
        category: prod.category,
        description: prod.description,
        itemAttributes: {
          name: prod.itemAttributes.name,
          type: prod.itemAttributes.type,
          subcategory: prod.itemAttributes.subcategory,
          productUrl: prod.itemAttributes.productUrl,
          imageUrl: prod.itemAttributes.imageUrl
        }
      };
      pushAddToCart([item]);
    });
  });

  // 全件追加ボタン
  document.getElementById('addAll').addEventListener('click', function(){
    var items = [];
    document.querySelectorAll('.qty').forEach(function(q){
      var idx = parseInt(q.getAttribute('data-idx'), 10);
      var qty = parseInt(q.value, 10) || 1;
      var p = PRODUCTS[idx];
      // 変更点: itemAttributes オブジェクトを構築
      items.push({
        sku: p.sku,
        quantity: qty,
        baseprice: p.baseprice,
        netprice: p.netprice,
        discount: p.discount,
        discountType: p.discountType,
        category: p.category,
        description: p.description,
        itemAttributes: {
          name: p.itemAttributes.name,
          type: p.itemAttributes.type,
          subcategory: p.itemAttributes.subcategory,
          productUrl: p.itemAttributes.productUrl,
          imageUrl: p.itemAttributes.imageUrl
        }
      });
    });
    if (items.length === 0) { alert('No items'); return; }
    pushAddToCart(items);
  });

  // Show last payload in console (debug)
  document.getElementById('showDL').addEventListener('click', function(){
    console.log('lastPayload:', lastPayload);
    alert('See console for last payload (開発者ツールのコンソールを確認してください)');
  });

  // New Cart ボタン
  document.getElementById('clearSession').addEventListener('click', function(){
    var newId = newCartId();
    alert('New cartId created: ' + newId);
    console.log('New cartId:', newId);
  });

  // ページロード時に cartId を表示（console）
  console.log('current cartId:', getSessionCartId());
  </script>
</body>
</html>
